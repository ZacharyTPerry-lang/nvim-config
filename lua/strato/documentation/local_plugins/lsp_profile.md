# LSP Profile System Documentation

## Overview

The LSP Profile System is a custom Neovim configuration that provides project-specific LSP configurations for C/C++ development using clangd. It automatically generates `.clangd` configuration files based on templates and can detect vendor dependencies from makefiles.

## Core Features

- **Profile-based configuration**: Different coding standards (JPL, standard, etc.)
- **Automatic vendor dependency detection**: Parses makefiles for include paths
- **Header file language detection**: Correctly identifies `.h` files as C or C++
- **Dynamic configuration updates**: Regenerates when templates or makefiles change
- **Safe project management**: Won't touch user-created `.clangd` files

## File Structure

```
~/.config/nvim/
├── lua/strato/
│   ├── lsp/
│   │   ├── profiles.lua          # Core profile management
│   │   ├── c/
│   │   │   ├── jpl/.clangd       # JPL C standard template
│   │   │   └── standard/.clangd  # Standard C template
│   │   └── cpp/
│   │       └── standard/.clangd  # Standard C++ template
│   └── lazy/
│       └── lsp.lua               # LSP configuration
```

Project structure:
```
project-root/
├── .lsp-profile       # Profile selection (e.g., "c:jpl")
├── makefile          # Build file with vendor paths
├── .clangd           # Auto-generated (DO NOT EDIT)
├── vendor/
│   ├── blake3/
│   └── flatcc/
└── src/
    ├── main.c
    └── main.h
```

## Profile Configuration

### Creating `.lsp-profile`

Create a `.lsp-profile` file in your project root:

```
c:jpl
```

Or for multiple languages:
```
c:jpl
cpp:standard
```

### Available Profiles

- `c:standard` - Basic C with warnings
- `c:jpl` - JPL Coding Standard (strict)
- `cpp:standard` - Basic C++ configuration

## Vendor Dependency Detection

The system automatically detects vendor dependencies from your makefile.

### Supported Patterns

1. **CFLAGS with -I flags**:
   ```makefile
   CFLAGS += -Ivendor/blake3
   CFLAGS += -Ivendor/flatcc/include
   ```

2. **Variable assignments**:
   ```makefile
   BLAKE3_DIR := vendor/blake3
   ```

### Requirements

- Makefile must be named `Makefile` or `makefile` (case-insensitive)
- Include paths are made absolute from project root
- Changes to makefile trigger automatic regeneration

## Header File Detection

The system intelligently detects whether `.h` files should be treated as C or C++:

1. **First priority**: Checks for corresponding source file
   - `foo.h` + `foo.c` exists → C
   - `foo.h` + `foo.cpp` exists → C++

2. **Second priority**: Checks `.lsp-profile`
   - Only `c:profile` defined → C
   - Only `cpp:profile` defined → C++

3. **Default**: C

## Commands

### `:LspProfiles [language]`
Show available profiles for a language, or list all configured languages.

### `:LspProfileInfo`
Display detailed information about current configuration:
- Active profile
- Project root
- Template path
- `.clangd` status
- Last modification time

### `:LspProfileReload`
Force regenerate the `.clangd` file:
- Clears cache
- Re-parses makefile
- Regenerates configuration
- Restarts clangd

### `:LspProfileClean`
Remove generated `.clangd` file (only if generated by profile system).

## Generated `.clangd` Format

Example generated file:
```yaml
# NVIM LSP PROFILES - jpl - TEMPLATE
# This file is auto-generated. Manual edits will be overwritten.
CompileFlags:
  Add:
    - -Wall
    - -Wextra
    - -std=c99
    # ... other flags ...
    # NVIM LSP PROFILES - DYNAMIC VENDOR INCLUDES
    - -I/absolute/path/to/project/vendor/blake3
    - -I/absolute/path/to/project/vendor/flatcc/include
Diagnostics:
  UnusedIncludes: Strict
  ClangTidy:
    Add:
      - cert-*
      # ... other checks ...
```

## Safety Features

1. **Project depth check**: Won't write to directories less than 4 levels deep
2. **Magic marker validation**: Only touches files with profile system markers
3. **User file protection**: Never overwrites manually created `.clangd` files
4. **Writable directory check**: Ensures directory is writable before operations

## Regeneration Triggers

The `.clangd` file regenerates when:

1. **File doesn't exist**: Initial generation
2. **Profile changed**: Different profile in `.lsp-profile`
3. **Template updated**: Template file is newer than generated file
4. **Makefile changed**: Makefile is newer than generated file
5. **Manual reload**: `:LspProfileReload` command

## Troubleshooting

### Include files not found

1. Check paths are in makefile CFLAGS:
   ```bash
   grep -E "CFLAGS.*-I" makefile
   ```

2. Verify `.clangd` has absolute paths:
   ```bash
   grep -- "-I" .clangd
   ```

3. Force regeneration:
   ```vim
   :LspProfileClean
   :LspProfileReload
   ```

### Wrong language detected for headers

1. Check for corresponding source files
2. Verify `.lsp-profile` content
3. Use `:LspProfileInfo` to see detected language

### Changes not taking effect

1. Ensure makefile saved
2. Run `:LspProfileReload`
3. Check `:LspLog` for errors

## Best Practices

1. **Consistent structure**: Keep vendor dependencies in `vendor/` directory
2. **Makefile organization**: Put all `-I` flags in CFLAGS lines
3. **Profile files**: Commit `.lsp-profile` to version control
4. **Generated files**: Add `.clangd` to `.gitignore`
5. **Templates**: Customize templates in `~/.config/nvim/lua/strato/lsp/{lang}/{profile}/`

## Technical Details

### Cache System

- Per-project cache prevents repeated processing
- Cache cleared on `:LspProfileReload`
- Stores profile name and check status

### Path Resolution

- Vendor paths extracted from makefile are relative
- System converts to absolute paths from project root
- Ensures clangd finds includes regardless of working directory

### Template System

- Templates are pure YAML files
- First line must be magic marker: `# NVIM LSP PROFILES - {profile} - TEMPLATE`
- Dynamic content injected into CompileFlags section
- Templates never modified, only copied

## Example Workflows

### Setting up a new C project with JPL standard:

1. Create `.lsp-profile`:
   ```bash
   echo "c:jpl" > .lsp-profile
   ```

2. Add to makefile:
   ```makefile
   CFLAGS += -Ivendor/mylib/include
   ```

3. Open a C file - configuration generates automatically

### Adding a new vendor dependency:

1. Add to makefile:
   ```makefile
   CFLAGS += -Ivendor/newlib
   ```

2. Save makefile
3. Run `:LspProfileReload` or restart Neovim
4. Vendor path automatically added to clangd config

### Switching profiles:

1. Edit `.lsp-profile`:
   ```bash
   vim .lsp-profile
   # Change c:standard to c:jpl
   ```

2. Run `:LspProfileReload`
3. New profile applied immediately

## Notes

- The system integrates with standard clangd functionality
- All clangd features remain available (jump to definition, diagnostics, etc.)
- Profile system only manages configuration generation
- Compatible with other LSP plugins and configurations
